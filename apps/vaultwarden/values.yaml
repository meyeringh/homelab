app-template:
  controllers:
    vaultwarden:
      containers:
        app:
          image:
            repository: docker.io/vaultwarden/server
            tag: testing
          env:
            DOMAIN: "https://vault.meyeringh.org"
            DATABASE_URL:
              valueFrom:
                secretKeyRef:
                  name: vaultwarden-postgres-app
                  key: uri
            ADMIN_TOKEN:
              valueFrom:
                secretKeyRef:
                  name: vaultwarden-admin
                  key: ADMIN_TOKEN
            SSO_ENABLED: "true"
            SSO_ONLY: "true"
            SSO_AUTHORITY: "https://dex.meyeringh.org"
            SSO_CLIENT_ID: "vaultwarden"
            SSO_CLIENT_SECRET:
              valueFrom:
                secretKeyRef:
                  name: vaultwarden-sso-secrets
                  key: SSO_CLIENT_SECRET
            SSO_SCOPES: "openid email profile"
            SSO_PKCE: "false"
            SMTP_HOST: "mail.meyeringh.org"
            SMTP_PORT: "587"
            SMTP_SECURITY: "starttls"
            SMTP_FROM:
              valueFrom:
                secretKeyRef:
                  name: vaultwarden-mail-secret
                  key: sender_mail
            SMTP_FROM_NAME: "Vaultwarden"
            SMTP_USERNAME:
              valueFrom:
                secretKeyRef:
                  name: vaultwarden-mail-secret
                  key: username
            SMTP_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: vaultwarden-mail-secret
                  key: password
          resources:
            requests:
              cpu: 10m
              memory: 100Mi
            limits:
              memory: 100Mi
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /
                  port: 80
                periodSeconds: 10
                failureThreshold: 3
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /
                  port: 80
                periodSeconds: 10
            startup:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /
                  port: 80
                periodSeconds: 10
                failureThreshold: 60

  service:
    app:
      controller: vaultwarden
      ports:
        http:
          port: 80

  ingress:
    main:
      enabled: true
      className: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        external-dns.alpha.kubernetes.io/target: "homelab-tunnel.meyeringh.org"
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
      hosts:
        - host: &host vault.meyeringh.org
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: app
                port: 80
      tls:
        - hosts:
            - *host
          secretName: vaultwarden-tls-certificate

  persistence:
    data:
      accessMode: ReadWriteOnce
      size: 5Gi
      retain: true
      globalMounts:
        - path: /data

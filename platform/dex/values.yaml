dex:
  resources:
    requests:
      cpu: 10m
      memory: 100Mi
    limits:
      memory: 100Mi

  serviceMonitor:
    enabled: true

  config:
    issuer: https://dex.meyeringh.org
    storage:
      type: kubernetes
      config:
        inCluster: true
    oauth2:
      skipApprovalScreen: true
    connectors:
      - type: oidc
        id: kanidm
        name: Kanidm
        config:
          clientID: $KANIDM_CLIENT_ID
          clientSecret: $KANIDM_CLIENT_SECRET
          redirectURI: https://dex.meyeringh.org/callback
          issuer: https://auth.meyeringh.org/oauth2/openid/dex
          # TODO https://github.com/dexidp/dex/pull/3188
          # enablePKCE: true
          scopes:
            - openid
            - profile
            - email
            - groups
    staticClients:
      - id: grafana-sso
        name: Grafana
        redirectURIs:
          - 'https://grafana.meyeringh.org/login/generic_oauth'
        secretEnv: GRAFANA_SSO_CLIENT_SECRET
      - id: gitea
        name: Gitea
        redirectURIs:
          - 'https://git.meyeringh.org/user/oauth2/Dex/callback'
        secretEnv: GITEA_CLIENT_SECRET
      - id: nextcloud
        name: Nextcloud
        redirectURIs:
          - 'https://cloud.meyeringh.org/apps/oidc_login/oidc'
        secretEnv: NEXTCLOUD_CLIENT_SECRET
      - id: paperless
        name: Paperless
        redirectURIs:
          - 'https://paperless.meyeringh.org/accounts/oidc/dex/login/callback/'
        secretEnv: PAPERLESS_CLIENT_SECRET
      - id: argocd
        name: ArgoCD
        redirectURIs:
          - 'https://argocd.meyeringh.org/auth/callback'
        secretEnv: ARGOCD_CLIENT_SECRET
      - id: webtrees
        name: Webtrees
        redirectURIs:
          - 'https://family.meyeringh.org/index.php?route=/OAuth2Client'
        secretEnv: WEBTREES_CLIENT_SECRET
      - id: jellyfin
        name: Jellyfin
        redirectURIs:
          - 'https://media.meyeringh.org/sso/OID/redirect/dex'
          - 'http://media.meyeringh.org/sso/OID/redirect/dex'
        secretEnv: JELLYFIN_CLIENT_SECRET
  envFrom:
    - secretRef:
        name: dex-secrets
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      external-dns.alpha.kubernetes.io/target: "homelab-tunnel.meyeringh.org"
      external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
    hosts:
      - host: &host dex.meyeringh.org
        paths:
          - path: /
            pathType: ImplementationSpecific
    tls:
      - secretName: dex-tls-certificate
        hosts:
          - *host

kube-prometheus-stack:
  prometheusOperator:
    resources:
      requests:
        cpu: 11m
        memory: 100Mi
      limits:
        memory: 100Mi

  kube-state-metrics:
    resources:
      requests:
        cpu: 10m
        memory: 100Mi
      limits:
        memory: 100Mi

  prometheus-node-exporter:
    resources:
      requests:
        cpu: 10m
        memory: 100Mi
      limits:
        memory: 100Mi

  # Disable controller manager monitoring for K3s
  # K3s embeds controller manager in the main server process
  kubeControllerManager:
    enabled: false

  # Disable scheduler monitoring for K3s
  # K3s embeds scheduler in the main server process
  kubeScheduler:
    enabled: false

  # Disable etcd monitoring for K3s
  # K3s uses embedded etcd that doesn't expose metrics by default
  kubeEtcd:
    enabled: false

  # Disable kube-proxy monitoring for K3s
  # K3s doesn't use traditional kube-proxy, it uses a different networking approach
  kubeProxy:
    enabled: false

  grafana:
    enabled: false
    forceDeployDatasources: true
    forceDeployDashboards: true
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki.loki:3100
  prometheus:
    prometheusSpec:
      resources:
        requests:
          cpu: 127m
          memory: 1569Mi
        limits:
          memory: 1569Mi
      containers:
        - name: config-reloader
          resources:
            requests:
              cpu: 10m
              memory: 100Mi
            limits:
              memory: 100Mi
      ruleSelectorNilUsesHelmValues: false
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      probeSelectorNilUsesHelmValues: false

  alertmanager:
    alertmanagerSpec:
      resources:
        requests:
          cpu: 10m
          memory: 100Mi
        limits:
          memory: 100Mi
      containers:
        - name: ntfy-relay
          image: ghcr.io/khuedoan/webhook-transformer:v0.0.3
          resources:
            requests:
              cpu: 10m
              memory: 100Mi
            limits:
              memory: 100Mi
          args:
            - --port=8081
            - --config=/config/alertmanager-to-ntfy.jsonnet
            - --upstream-host=https://ntfy.sh
          envFrom:
            - secretRef:
                name: webhook-transformer
          volumeMounts:
            - name: config
              mountPath: /config
        - name: config-reloader
          resources:
            requests:
              cpu: 10m
              memory: 100Mi
            limits:
              memory: 100Mi
      volumes:
        - name: config
          configMap:
            name: webhook-transformer
    config:
      route:
        receiver: ntfy
        group_by:
          - namespace
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 12h
        routes:
          - receiver: "null"
            matchers:
              - alertname = "InfoInhibitor"
          - receiver: ntfy
            matchers:
              - alertname = "Watchdog"
      receivers:
        - name: "null"
        - name: ntfy
          webhook_configs:
            - url: http://localhost:8081
              send_resolved: true
